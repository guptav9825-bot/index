<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sarkari Photo Studio | All-in-One</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@latest/dist/index.js"></script>

    <style>
        :root { --red: #d32f2f; --blue: #1a73e8; --green: #2e7d32; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: auto; background: #fff; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); overflow: hidden; border-top: 10px solid var(--red); }
        .header { padding: 15px; text-align: center; border-bottom: 1px solid #eee; background: #fff; }
        .header h1 { margin: 0; color: var(--red); font-size: 26px; text-transform: uppercase; }
        
        .main-layout { display: flex; flex-wrap: wrap; gap: 20px; padding: 20px; }
        .editor-side { flex: 1; min-width: 350px; background: #222; border-radius: 10px; overflow: hidden; min-height: 450px; display: flex; align-items: center; justify-content: center; position: relative; }
        #image-to-edit { max-width: 100%; display: block; }
        
        .control-side { width: 320px; background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #ddd; }
        .section-title { font-weight: bold; margin: 15px 0 8px; font-size: 14px; color: #444; border-left: 4px solid var(--red); padding-left: 8px; }
        
        .upload-btn { background: var(--blue); color: white; padding: 12px; text-align: center; border-radius: 6px; cursor: pointer; display: block; font-weight: bold; margin-bottom: 10px; }
        .ai-btn { background: #9c27b0; color: white; border: none; padding: 10px; width: 100%; border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        
        .input-box { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 8px; box-sizing: border-box; }
        .kb-info { background: #fff; border: 2px dashed var(--red); padding: 12px; text-align: center; border-radius: 8px; font-weight: bold; font-size: 20px; color: var(--red); margin: 15px 0; }
        
        .download-btn { background: var(--green); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .preset-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .p-btn { background: white; border: 1px solid #ccc; padding: 6px; font-size: 12px; cursor: pointer; border-radius: 4px; }
        
        #loading-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: white; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Sarkari AI Photo Studio</h1>
        <p style="margin:5px 0; color:#666;">Crop • Remove BG • Name/Date • KB Resize</p>
    </div>

    <div class="main-layout">
        <div class="editor-side">
            <div id="loading-overlay">
                <div class="spinner"></div>
                <p id="status-text">AI is working...</p>
            </div>
            <img id="image-to-edit">
        </div>

        <div class="control-side">
            <label class="upload-btn">
                1. UPLOAD PHOTO
                <input type="file" id="imgFile" accept="image/*" hidden>
            </label>

            <button class="ai-btn" onclick="removeBackground()">✨ AUTO REMOVE BACKGROUND</button>

            <div class="section-title">2. EXAM PRESETS</div>
            <div class="preset-btns">
                <button class="p-btn" onclick="setRes(350, 450)">SSC/UPP Photo</button>
                <button class="p-btn" onclick="setRes(350, 150)">Signature</button>
                <button class="p-btn" onclick="setRes(350, 350)">UPSC/IBPS</button>
                <button class="p-btn" onclick="setRes(413, 531)">Passport Size</button>
            </div>

            <div class="section-title">3. ADD NAME & DATE</div>
            <input type="text" id="uName" class="input-box" placeholder="Student Name" oninput="refreshPreview()">
            <input type="text" id="uDate" class="input-box" placeholder="Date of Photo" oninput="refreshPreview()">

            <div class="section-title">4. QUALITY & SIZE (KB)</div>
            <input type="range" id="qRange" min="0.1" max="1.0" step="0.01" value="0.8" style="width:100%" oninput="refreshPreview()">
            <div class="kb-info"><span id="kb-display">0</span> KB</div>

            <input type="hidden" id="wVal" value="350">
            <input type="hidden" id="hVal" value="450">

            <button class="download-btn" onclick="saveFinalImage()">DOWNLOAD FINAL</button>
        </div>
    </div>
</div>

<script>
    let cropper;
    const imgEl = document.getElementById('image-to-edit');
    const overlay = document.getElementById('loading-overlay');

    // 1. Handle Upload
    document.getElementById('imgFile').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                imgEl.src = ev.target.result;
                initCropper();
            };
            reader.readAsDataURL(file);
        }
    };

    function initCropper() {
        if (cropper) cropper.destroy();
        cropper = new Cropper(imgEl, {
            aspectRatio: NaN,
            viewMode: 1,
            crop() { refreshPreview(); }
        });
    }

    // 2. AI Background Removal
    async function removeBackground() {
        if (!cropper) return alert("Pehle photo upload karein!");
        overlay.style.display = 'flex';
        document.getElementById('status-text').innerText = "Removing Background (AI)...";

        try {
            const croppedCanvas = cropper.getCroppedCanvas();
            const blob = await new Promise(resolve => croppedCanvas.toBlob(resolve, 'image/png'));
            const resultBlob = await imglyConfig.removeBackground(blob);
            const url = URL.createObjectURL(resultBlob);
            
            cropper.destroy();
            imgEl.src = url;
            imgEl.onload = () => {
                initCropper();
                overlay.style.display = 'none';
            };
        } catch (err) {
            alert("Error: Background remove nahi ho paya.");
            overlay.style.display = 'none';
        }
    }

    function setRes(w, h) {
        document.getElementById('wVal').value = w;
        document.getElementById('hVal').value = h;
        refreshPreview();
    }

    // 3. Final Canvas Processing
    function refreshPreview() {
        if (!cropper) return;
        const w = parseInt(document.getElementById('wVal').value);
        const h = parseInt(document.getElementById('hVal').value);
        const q = parseFloat(document.getElementById('qRange').value);
        const name = document.getElementById('uName').value.toUpperCase();
        const date = document.getElementById('uDate').value;

        const canvas = cropper.getCroppedCanvas({ width: w, height: h });
        const ctx = canvas.getContext('2d');

        if (name || date) {
            const sh = h * 0.22;
            ctx.fillStyle = "white";
            ctx.fillRect(0, h - sh, w, sh);
            ctx.fillStyle = "black";
            ctx.textAlign = "center";
            ctx.font = `bold ${sh * 0.35}px Arial`;
            ctx.fillText(name, w / 2, h - (sh * 0.55));
            ctx.font = `${sh * 0.3}px Arial`;
            ctx.fillText(date, w / 2, h - (sh * 0.15));
        }

        const dataUrl = canvas.toDataURL('image/jpeg', q);
        const kb = (dataUrl.length * 0.75 / 1024).toFixed(2);
        document.getElementById('kb-display').innerText = kb;
        return dataUrl;
    }

    function saveFinalImage() {
        const data = refreshPreview();
        if(!data) return;
        const a = document.createElement('a');
        a.href = data;
        a.download = "sarkari-ai-photo.jpg";
        a.click();
    }
</script>

</body>
</html>
